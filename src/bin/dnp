#!/bin/bash
# bin/dnp

DOCUMENTATION_BUFFER_DNP=$( cat <<'EOF'
# =================================================================================================
#                                  Dockerized-NorLab-Project (DNP)
#                         A tool for managing Docker-based robotic projects
#
# Usage:
#   $ dnp COMMAND [OPTIONS]
#
# Commands:
#   init        Initialize a new DNP project
#   build       Build DNP Docker images
#   up          Start and attach to a container (daemon mode)
#   down        Stop containers
#   attach      Attach to a running container
#   exec        Execute command in a running container
#   run         Run a command in a container
#   project     Super project commands
#   save        Save DNP Docker image to file for offline use
#   load        Load DNP Docker image from file for offline use
#   config      (In-progress) Show configuration
#   version     Show DNP version
#   help        Show this help message
#
# Run 'dnp COMMAND --help' for more information on a command.
#
# =================================================================================================
EOF
)

# ....Find path to script........................................................................
# Note: can handle both sourcing cases
#   i.e. from within a script or from an interactive terminal session
# Check if running interactively
if [[ $- == *i* ]]; then
  # Case: running in an interactive session
  _target_path=$(realpath .)
else
  # Case: running in an non-interactive session
  _script_path="$(realpath -q "${BASH_SOURCE[0]:-.}")"
  _target_path="$(dirname "${_script_path}")"
fi
dnp_core="$(dirname "${_target_path}")/lib/core"

# ::::Load dependencies::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
source "${dnp_core}/utils/import_dnp_lib.bash" || exit 1

# ::::Pre-condition::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
dnp_error_prefix="\033[1;31m[DNP error]\033[0m"
test -n "$( declare -f dnp::import_lib_and_dependencies )" || { echo -e "${dnp_error_prefix} The DNP lib is not loaded!" ; exit 1 ; }
test -n "$( declare -f n2st::print_msg )" || { echo -e "${dnp_error_prefix} The N2ST lib is not loaded!" ; exit 1 ; }
test -d "${DNP_ROOT:?err}" || { echo -e "${dnp_error_prefix} library load error!" ; exit 1 ; }
test -d "${DNP_LIB_PATH:?err}" || { echo -e "${dnp_error_prefix} library load error!" ; exit 1 ; }

# ::::Command functions::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
function dnp::entrypoint() {

  # ....Set env variables (pre cli)................................................................
  local the_command="$1"
  shift || true

  # ....cli........................................................................................
  if [[ -z ${the_command}  ]]; then
    dnp::show_entrypoint_help "${DOCUMENTATION_BUFFER_DNP:?err}"
    exit 0
  fi

  case "${the_command}" in
      init)
          source "${DNP_LIB_PATH}/commands/init.bash" || exit 1
          dnp::init_command "$@"
          exit $?
          ;;
      build)
          source "${DNP_LIB_PATH}/commands/build.bash" || exit 1
          dnp::build_command "$@"
          exit $?
          ;;
      save)
          source "${DNP_LIB_PATH}/commands/save.bash" || exit 1
          dnp::save_command "$@"
          exit $?
          ;;
      load)
          source "${DNP_LIB_PATH}/commands/load.bash" || exit 1
          dnp::load_command "$@"
          exit $?
          ;;
      exec)
          source "${DNP_LIB_PATH}/commands/exec.bash" || exit 1
          dnp::exec_command "$@"
          exit $?
          ;;
      attach)
          source "${DNP_LIB_PATH}/commands/attach.bash" || exit 1
          dnp::attach_command "$@"
          exit $?
          ;;
      up)
          source "${DNP_LIB_PATH}/commands/up.bash" || exit 1
          dnp::up_command "$@"
          exit $?
          ;;
      down)
          source "${DNP_LIB_PATH}/commands/down.bash" || exit 1
          dnp::down_command "$@"
          exit $?
          ;;
      run)
          source "${DNP_LIB_PATH}/commands/run.bash" || exit 1
          dnp::run_command "$@"
          exit $?
          ;;
      config)
          source "${DNP_LIB_PATH}/commands/config.bash" || exit 1
          dnp::config_command "$@"
          exit $?
          ;;
      version)
          source "${DNP_LIB_PATH}/commands/version.bash" || exit 1
          dnp::version_command "$@"
          exit $?
          ;;
      project)
          sub_the_command="$1"
          shift || true

          source "${DNP_LIB_PATH}/commands/project.bash" || exit 1
          if [[ -z ${sub_the_command}  ]]; then
            dnp::command_help_menu "${DOCUMENTATION_BUFFER_PROJECT:?err}"
            exit 0
          fi

          case "${sub_the_command}" in
              validate)
                  dnp::project_validate_command "$@"
                  exit $?
                  ;;
              sanity)
                  dnp::project_sanity_command "$@"
                  exit $?
                  ;;
              dotenv)
                  dnp::project_dotenv_command "$@"
                  exit $?
                  ;;
              help|--help|-h)
                  dnp::command_help_menu "${DOCUMENTATION_BUFFER_PROJECT:?err}"
                  exit 0
                  ;;
              *)
                  dnp::unknown_subcommand_msg "project" "${sub_the_command}"
                  exit 1
                  ;;
          esac
          ;;
      help|--help|-h)
          dnp::show_entrypoint_help "${DOCUMENTATION_BUFFER_DNP:?err}"
          exit 0
          ;;
      *)
          dnp::unknown_command_msg "${the_command}"
          exit 1
          ;;
  esac
}

# ::::Main:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
dnp::entrypoint "$@"
